---
- name: Perform Initial Setup on Proxmox VE Hosts
  hosts: proxmox_hosts
  become: yes
  gather_facts: no

  tasks:
    - name: 1. Disable the PVE Enterprise APT Repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        regexp: '^deb https://enterprise.proxmox.com/debian/pve'
        line: '# deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise'
        state: present
      tags: apt

    - name: 2. Disable the Ceph Enterprise APT Repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/ceph.list
        regexp: '^deb https://enterprise.proxmox.com/debian/ceph-quincy'
        line: '# deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise'
        state: present
      tags: apt

    - name: 3. Add the PVE No-Subscription APT Repositories
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
          deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription
        mode: '0644'
      tags: apt

    - name: 4. Update APT cache to apply repository changes
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: apt

    - name: 5. Install common useful packages
      ansible.builtin.apt:
        name:
          - htop
          - ncdu
          - git
          - vim
          - smartmontools
          - lm-sensors
        state: present
      tags: packages